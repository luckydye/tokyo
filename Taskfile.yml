# https://taskfile.dev

version: "3"

dotenv: [".env"]

includes:
  library:
    aliases: [lib]
    dir: apps/library
    taskfile: apps/library/Taskfile.yml

  app:
    aliases: [app]
    dir: apps/app
    taskfile: apps/app/Taskfile.yml

  website:
    aliases: [web]
    dir: apps/website
    taskfile: apps/website/Taskfile.yml

tasks:
  run:
    desc: Run a task recursivly in all included Taskfiles.
    vars:
      TASK: '{{.TASK | default "help"}}'
      TASKS:
        sh: echo $(task --list --json | jq -r '.tasks[] | select(.name | contains(":{{.TASK}}")).name')
    cmds:
      - task --parallel {{.TASKS}}

  setup:ubuntu:
    desc: Install system dependencies
    dir: "."
    cmds:
      - sudo apt update
      - sudo apt install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libsqlite3-dev
      - task: setup

  setup:
    desc: Install dependencies
    dir: "."
    sources:
      - .rtx.toml
      - bun.lockb
      - package.json
      - Cargo.toml
      - Cargo.lock
      - "**/package.json"
    cmds:
      - rtx install
      - task: codegen
      - cargo check
      - bun install
      - cargo install cargo-watch
      - cargo install wasm-pack
      - cargo install tauri-cli --version "^2.0.0-alpha"

  codegen:
    dir: "./packages/proto"
    cmds:
      - cargo install protobuf-codegen
      - bun x cargo run --bin force-build

  reset:
    desc: Reset repository files
    prompt: Do you really want to reset the repository?
    cmd: git clean -xdf .

  dev:
    desc: Run desktop app with library
    vars:
      deps:
        sh: task setup
    cmd: task --parallel app:dev

  dev:server:
    desc: Run desktop app with library
    vars:
      deps:
        sh: task setup
    cmd: task --parallel library:dev app:dev

  dev:ios:
    desc: Run ios app in simulator
    vars:
      deps:
        sh: task setup
    cmd: task --parallel library:dev app:dev:ios

  build:
    desc: Build app
    vars:
      deps:
        sh: task setup
    cmd: task --parallel library:build app:build

  build:docker:
    desc: Build docker image for library server
    cmds:
      - docker buildx build --platform linux/amd64 . --tag tokyo/library:latest

  check:
    desc: Check files
    dir: ./
    cmds:
      - cargo check
      - bun x biome check ./ {{.CLI_ARGS}}
